<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Formula-based simulation constraints â€¢ ProCESS</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Formula-based simulation constraints">
<meta name="description" content="Simulate a tissue evolution until a simulation state formula does not hold
">
<meta property="og:description" content="Simulate a tissue evolution until a simulation state formula does not hold
">
<meta property="og:image" content="https://caravagnalab.github.io/ProCESS/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ProCESS</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/ProCESS.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/tissue_simulation.html">Tissue simulation</a></li>
    <li><a class="dropdown-item" href="../articles/sampling.html">Tissue sampling</a></li>
    <li><a class="dropdown-item" href="../articles/mutations.html">Simulating Mutations</a></li>
    <li><a class="dropdown-item" href="../articles/sequencing.html">Sequencing Simulation</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/caravagnalab/ProCESS/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Formula-based simulation constraints</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/caravagnalab/ProCESS/vignettes/run_until.Rmd" class="external-link"><code>vignettes/run_until.Rmd</code></a></small>
      <div class="d-none name"><code>run_until.Rmd</code></div>
    </div>

    
    
<blockquote>
<p><em>Note:</em> This article presents advanced topics on tissue
simulation. Refer to <code><a href="../articles/tissue_simulation.html">vignette("tissue_simulation")</a></code> for an
introduction of the subject.</p>
</blockquote>
<blockquote>
<p><em>Disclaimer:</em> RACES/ProCESS internally implements the
probability distributions using the C++11 random number distribution
classes. The standard does not specify their algorithms, and the class
implementations are left free for the compiler. Thus, the simulation
output depends on the compiler used to compile RACES, and because of
that, the results reported in this article may differ from those
obtained by the reader.</p>
</blockquote>
<p>ProCESS implements a first order unquantified logic having variables
representing the cardinality of the species, the number of events fired
in a species (being duplications, deaths, or switches), and the
simulation time. These variables and reals values are summed by
<code>+</code>, subtracted by <code>-</code>, and multiplied by
<code>*</code> and form expressions. The expressions are then compared
with the standard semantics by <code>&gt;</code>, <code>&gt;=</code>,
<code>==</code>, <code>!=</code>, <code>&lt;=</code>, and
<code>&lt;</code> to form relations. A formula in this language is
either a relation, the conjunction of two formulas (<code>&amp;</code>),
or the disjunction of two formulas (<code>|</code>).</p>
<p>Any formula in above language expresses a condition on the simulation
status and it can be used as the parameter of the method
<code>SpatialSimulation$run_until()</code> to let the simulation evolve
until the condition does not hold.</p>
<div class="section level3">
<h3 id="variables">Variables<a class="anchor" aria-label="anchor" href="#variables"></a>
</h3>
<p>The variables represent one among the following quantities:</p>
<ul>
<li>the cardinality of a species;</li>
<li>the number fired event among deaths, duplications and switches in a
species;</li>
<li>the elapse simulation time.</li>
</ul>
<p>All above variables can be built by using the method
<code>SpatialSimulation$var()</code>. When the parameter is the string
<code>"Time"</code>, the elapsed simulation time variable is
returned.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://caravagnalab.github.io/ProCESS">ProCESS</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set the seed of the random number generator</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># build a spatial simulation and add two species to it</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SpatialSimulation.html">SpatialSimulation</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sim</span><span class="op">$</span><span class="fu">add_mutant</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>               epigenetic_rates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"+-"</span> <span class="op">=</span> <span class="fl">0.01</span>, <span class="st">"-+"</span> <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>,</span>
<span>               growth_rates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"+"</span> <span class="op">=</span> <span class="fl">0.2</span>, <span class="st">"-"</span> <span class="op">=</span> <span class="fl">0.08</span><span class="op">)</span>,</span>
<span>               death_rates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"+"</span> <span class="op">=</span> <span class="fl">0.1</span>, <span class="st">"-"</span> <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get the variable representing the simulation time</span></span>
<span><span class="va">v_time</span> <span class="op">&lt;-</span> <span class="va">sim</span><span class="op">$</span><span class="fu">var</span><span class="op">(</span><span class="st">"Time"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">v_time</span></span>
<span><span class="co">#&gt; Time</span></span></code></pre></div>
<p>When the parameter is the name of a species, a variable representing
the cardinality of the species is built.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get the variable representing the cardinality of A+ in sim</span></span>
<span><span class="va">va_p</span> <span class="op">&lt;-</span> <span class="va">sim</span><span class="op">$</span><span class="fu">var</span><span class="op">(</span><span class="st">"A+"</span><span class="op">)</span></span>
<span><span class="va">va_p</span></span>
<span><span class="co">#&gt; |A+|</span></span>
<span></span>
<span><span class="co"># get the variable representing the cardinality of A- in sim</span></span>
<span><span class="va">va_m</span> <span class="op">&lt;-</span> <span class="va">sim</span><span class="op">$</span><span class="fu">var</span><span class="op">(</span><span class="st">"A-"</span><span class="op">)</span></span>
<span><span class="va">va_m</span></span>
<span><span class="co">#&gt; |A-|</span></span></code></pre></div>
<p>Finally, when the parameter is the name of a species followed by a
<code>.</code> and the name of an event among <code>deaths</code>,
<code>duplications</code>, or <code>switches</code>,
<code>SpatialSimulation$var()</code> returns the variable associated
with the number of the corresponding event in the specified species.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get the variable representing the number of epigenetic</span></span>
<span><span class="co"># switches from A+</span></span>
<span><span class="va">va_ps</span> <span class="op">&lt;-</span> <span class="va">sim</span><span class="op">$</span><span class="fu">var</span><span class="op">(</span><span class="st">"A+.switches"</span><span class="op">)</span></span>
<span><span class="va">va_ps</span></span>
<span><span class="co">#&gt; |A+.switches|</span></span>
<span></span>
<span><span class="co"># get the variable representing the number of duplications in A+</span></span>
<span><span class="va">sim</span><span class="op">$</span><span class="fu">var</span><span class="op">(</span><span class="st">"A+.duplications"</span><span class="op">)</span></span>
<span><span class="co">#&gt; |A+.duplications|</span></span>
<span></span>
<span><span class="co"># get the variable representing the number of deaths in A+</span></span>
<span><span class="va">sim</span><span class="op">$</span><span class="fu">var</span><span class="op">(</span><span class="st">"A+.deaths"</span><span class="op">)</span></span>
<span><span class="co">#&gt; |A+.deaths|</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="expressions-and-formulas">Expressions and Formulas<a class="anchor" aria-label="anchor" href="#expressions-and-formulas"></a>
</h3>
<p>An expression is one of the following object:</p>
<ul>
<li>a variable, e.g., <code>sim$var("A+")</code>;</li>
<li>a numeric value, e.g., <code>3.4</code>;</li>
<li>the sum of two expressions, e.g.,
<code>sim$var("A+") + 3.4</code>;</li>
<li>the subtraction of two expressions, e.g.,
<code>sim$var("A+") - 3.4</code>;</li>
<li>the multiplication of two expressions, e.g.,
<code>sim$var("A+") * 3.4</code>.</li>
</ul>
<p>Two expression can be related by <code>&lt;=</code>,
<code>&lt;</code>, <code>==</code>, <code>!=</code>, <code>&gt;</code>
and <code>&gt;=</code>.</p>
<p>A formula is:</p>
<ul>
<li>a relation among two expressions, e.g.,
<code>sim$var("A+")&gt;=2</code>;</li>
<li>the conjunction of two formulas, e.g.,
<code>sim$var("A+")&gt;=2 &amp; sim$var("A+")&lt;=500</code>;</li>
<li>the disjunction of two formulas, e.g.,
<code>sim$var("A+")&gt;=2 | sim$var("A+")&lt;=500</code>.</li>
</ul>
</div>
<div class="section level3">
<h3 id="the-method-spatialsimulationrun_until">The method <code>SpatialSimulation$run_until()</code><a class="anchor" aria-label="anchor" href="#the-method-spatialsimulationrun_until"></a>
</h3>
<p>The method <code>SpatialSimulation$run_until()</code> takes as the
parameter a formula and lets the simulation evolve until the formula
does not hold.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># build a condition stating that the cardinality of A+ doubles</span></span>
<span><span class="co"># that of A-</span></span>
<span><span class="va">c1</span> <span class="op">&lt;-</span> <span class="va">va_p</span> <span class="op">&gt;=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">va_m</span></span>
<span><span class="va">c1</span></span>
<span><span class="co">#&gt; |A+|&gt;=2*|A-|</span></span>
<span></span>
<span><span class="co"># build a condition that holds when there are more than</span></span>
<span><span class="co"># 100000 live cells of mutant A</span></span>
<span><span class="va">c2</span> <span class="op">&lt;-</span> <span class="va">va_p</span> <span class="op">+</span> <span class="va">va_m</span> <span class="op">&gt;</span> <span class="fl">1e5</span></span>
<span><span class="va">c2</span></span>
<span><span class="co">#&gt; |A+|+|A-|&gt;100000</span></span>
<span></span>
<span><span class="co"># build a condition that holds when less than 4000</span></span>
<span><span class="co"># epigenetic switches from the species A+ have occured</span></span>
<span><span class="va">c3</span> <span class="op">&lt;-</span> <span class="va">va_ps</span> <span class="op">&lt;</span> <span class="fl">4000</span></span>
<span><span class="va">c3</span></span>
<span><span class="co">#&gt; 4000&gt;|A+.switches|</span></span>
<span></span>
<span><span class="co"># build a condition that holds when 40 time unit have been</span></span>
<span><span class="co"># simulated at least</span></span>
<span><span class="va">c4</span> <span class="op">&lt;-</span> <span class="va">v_time</span> <span class="op">&gt;=</span> <span class="fl">40</span></span>
<span><span class="va">c4</span></span>
<span><span class="co">#&gt; Time&gt;=40</span></span>
<span></span>
<span><span class="co"># build a condition that holds when c4 and at least one</span></span>
<span><span class="co"># among c1, c2, and c3 hold</span></span>
<span><span class="va">c5</span> <span class="op">&lt;-</span> <span class="va">c4</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">c1</span> <span class="op">|</span> <span class="va">c2</span> <span class="op">|</span> <span class="va">c3</span><span class="op">)</span></span>
<span><span class="va">c5</span></span>
<span><span class="co">#&gt; Time&gt;=40 and (|A+|&gt;=2*|A-| or |A+|+|A-|&gt;100000 or 4000&gt;|A+.switches|)</span></span>
<span></span>
<span><span class="co"># place the initial cell</span></span>
<span><span class="va">sim</span><span class="op">$</span><span class="fu">place_cell</span><span class="op">(</span><span class="st">"A+"</span>, <span class="fl">500</span>, <span class="fl">500</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># run the simulation while c5 does not hold</span></span>
<span><span class="va">sim</span><span class="op">$</span><span class="fu">run_until</span><span class="op">(</span><span class="va">c5</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100% [00m:00s] Saving snapshot</span></span>
<span></span>
<span><span class="va">sim</span></span>
<span><span class="co">#&gt; â”€â”€ <span style="background-color: #BBBB00;"> ProCESS </span> <span style="color: #BBBBBB; background-color: #00BB00;"> D </span> <span style="color: #BBBBBB; background-color: #BB0000;"> S </span> <span style="color: #BBBBBB; background-color: #BB0000;"> M </span> /var/folders/tb/jqmdpgxs2t5129bny6pb96680000gn/T/ProCES</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; â”€â”€ Species: <span style="color: #00BB00;">2</span>, <span style="color: #00BB00;">with</span> epigenetics</span></span>
<span><span class="co">#&gt;    </span></span>
<span><span class="co">#&gt;    =======  ====  ====  ====  ======  ===</span></span>
<span><span class="co">#&gt;    species   Î»      Î´    Îµ    counts   % </span></span>
<span><span class="co">#&gt;    =======  ====  ====  ====  ======  ===</span></span>
<span><span class="co">#&gt;         A-  0.08  0.01  0.01    30    75 </span></span>
<span><span class="co">#&gt;         A+  0.20  0.10  0.01    10    25 </span></span>
<span><span class="co">#&gt;    =======  ====  ====  ====  ======  ===</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; â”€â”€ Firings: 73 total</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Species [A-]:  5 (deaths), 37 (duplications) and  5 (switches)</span></span>
<span><span class="co">#&gt;  Species [A+]:  8 (deaths), 15 (duplications) and  3 (switches)</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">âœ–</span> The simulation has no samples yet!</span></span>
<span><span class="va">sim</span><span class="op">$</span><span class="fu">get_clock</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 40.34598</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Alberto Casagrande, Giulio Caravagna.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
