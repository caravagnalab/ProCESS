set -x
set -e

which cmake

rm -rf _builds _include RACES

git clone https://github.com/albertocasagrande/RACES.git

(cd RACES; git checkout 715f45485d44)

cmake -H./RACES/ -B_builds \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=_install \
    -DCMAKE_SHARED_LIBRARY_PREFIX_CXX="" \
    -DONLY_LIBRARIES=1 -DAVOID_OPTIONAL_LIBS=1
    #-DCMAKE_VERBOSE_MAKEFILE=ON \

cmake --build _builds --target install --config Release

# Linux
cp _install/lib/libRACES.so src/ || echo "Failed: libRACES.so -> src"

# Mac
cp _install/lib/RACES.dylib src/libRACES.so || echo "Failed: RACES.dylib -> src"
cp _install/lib/libRACES.a src/libRACES.so || echo "Failed: libRACES.dylib -> src"

${R_HOME}/bin/R --vanilla --silent -e 'Rcpp::compileAttributes()'

