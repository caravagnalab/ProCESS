---
title: "R interface"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{R_interface}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(rRACES)
```

# Simulating tumour growth

This is an example run with the R interface, it follows the same lines of the Rcpp interface.

## Creating a simulation

In the R interface we create with a single command the simulation and tissue

```{r}
x <- create_simulation(
  name = "My Test rRACES",        # Name of the simulation
  output_dir = "some_folder",     # Output folder
  tissue = "A fake liver",        # Name of the tissue
  tissue_size = c(1000, 1000)     # Size of the tissue
)
```

The S3 class provide a print method that recapitulates the current object state. In the top left corner, the flags are red representing that the model cannot yet generate the dynamics (D) of the species.
```{r}
x
```

The object contains a `simulation` field that is essentially an S4 `Simulation` instance as created using the Rcpp interface. The object is however wrapped with a lot of extra information to help visualisations of the simulation results.

```{r}
# The S4 Simulation object
x$simulation
```

## Species and their evolutionary relations

Species are addedd following a logic as for the Rcpp interface.

```{r}
# Add species A
x = add_species(
    x,
    name = "A",
    epigenetic_rates = c("+-" = 0.01, "-+" = 0.01),
    growth_rates = c("+" = 0.2, "-" = 0.08),
    death_rates = c("+" = 0.1, "-" = 0.01)
)

# Add species B
x = add_species(
  x,
  name = "B",
  epigenetic_rates = c("+-" = 0.01, "-+" = 0.01),
  growth_rates = c("+" = 0.25, "-" = 0.15),
  death_rates = c("+" = 0.05, "-" = 0.05)
)

# Visualise the simulation
x
```

We define the evolutionary relation between the involved genotypes.

```{r, eval=FALSE}
# Program a timed transition from species "A" to species "B" at time 60
x = add_genotype_evolution(x, "A", "B", 60)
```

## Initial cell displacement

We add one cell of species `A+` (genotype `A` in epistate `+`) in position `(500, 500)`.

```{r, eval=FALSE}
# Add one cell to the simulated tissue
x = set_initial_cell(
  x,
  genotype = "A",
  epistate = "+",
  position = c(500, 500)
)

# Query the internal object
x$simulation$get_cells()
```


Now the flag dynamics (D) becomes green because we have all info to simulate the model.
```{r, eval=FALSE}
x
```

## Simulation of the evolution of the species

The advantage of this interface compared to the Rcpp one is that it easily wraps visualisation functions.

Run the simulation up to some time
```{r, eval=FALSE}
# Clock is 0
x$simulation$get_clock()

x = run(x, what = list(time = 80))

# Clock (it is ~80)
x$simulation$get_clock()

```

We can plot the proportion of all species in the simulation.

```{r, eval=FALSE}
# Counts
x$simulation$get_counts()

plot_state(x)
```

We can plot the cells over the tissue. Since all plots are `ggplots`, we can modify them as much as we like.

```{r,  fig.height=4, fig.width=4, eval=FALSE}
# Cells
x$simulation$get_cells() %>% head

# Cells over tissue
plot_tissue(x)
```

```{r,  fig.height=4, fig.width=8, message=FALSE, warning=FALSE, eval=FALSE}
library(ggplot2)

# Cells over split by epistate
plot_tissue(x) + facet_wrap(~epistate)
```

```{r,  fig.height=8, fig.width=8, message=FALSE, warning=FALSE, eval=FALSE}
# Cells over split by epistate
plot_tissue(x) + facet_grid(genotype~epistate)
```

Run the simulation up to when a species reaches a certain size
```{r, eval=FALSE}
# Get the counts for species A+
Ap_count = x$simulation$get_counts() %>%
  filter(genotype == "A", epistate == "+") %>%
  pull(counts)

print(Ap_count)

# Run until we get 1000 more of A+
x = run(x, what = list(genotype = "A", epistate = "+", size = Ap_count + 1000))

# Check that we have Ap_count + 1000
x$simulation$get_counts() %>%
  filter(genotype == "A", epistate == "+") %>%
  pull(counts)
```

```{r,  fig.height=4, fig.width=4, message=FALSE, warning=FALSE, eval=FALSE}
plot_state(x)
plot_tissue(x)
```


Run until we have certain number of events.

```{r, eval=FALSE}
# See how many firings we had
x$simulation$get_firings()

# Get the counts for species A+
Ap_switches = x$simulation$get_firings() %>%
  filter(genotype == "A", epistate == "+", events == "switch") %>%
  pull(firings)

print(Ap_switches)

# Run until we get 200 more of A+ switching to A-
x = run(x, what = list(genotype = "A", epistate = "+",
                       event = "switch", count = Ap_switches + 200))

# Check that we have Ap_switches + 200
x$simulation$get_firings() %>%
  filter(genotype == "A", epistate == "+", events == "switch") %>%
  pull(firings)

x$simulation$get_counts() %>%
  filter(genotype == "A", epistate == "+") %>%
  pull(counts)
```

Plot firings statistics
```{r,  fig.height=4, fig.width=8, message=FALSE, warning=FALSE, eval=FALSE}
plot_firings(x)
```
