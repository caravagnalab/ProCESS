---
title: "Sampling a Simulated Tissue"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Sampling a Simulated Tissue}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(rRACES)
library(dplyr)
```

 
This document demonstrates how extract samples from simulated tissues and 
build the forests of the sampled cell ancestors.
(please, refer to [this](https://caravagnalab.github.io/rRACES/articles/a01_tissue_simulation.html)
document for tissue simulation examples). 
Two types of simulations are considered: one with a single population, and another with two. 

The presented samplings are of the most general type and include:

- *multi-region*: at every time point multiple spatially-separated samples are collected;
- *longitudinal*: the sampling is repeated at multiple time-points.

## Example with one population

### Tissue simulation

First of all, let us build and simulate a simple monoclonal model.

```{r, eval=TRUE}
# Monoclonal model, no epigenetic rates
sim <- new(Simulation, "Monoclonal")

sim$add_genotype(name = "A", growth_rates = 0.1, death_rates = 0.01)

sim$place_cell("A", 500, 500)
sim$run_up_to_size("A", 200000)
```

```{r,  fig.height=4, fig.width=3}
current <- plot_tissue(sim)
current
```

### First sampling

A sample is defined by a name and a bounding box, which has these parameters:

- a $(x,y)$ coordinate for the bottom left point;
- a $(x,y)$ coordinate for the top right point.

For this simulation, we define two samples with names `"A1"` and `"B1"`. 

```{r}
# We collect a box of 100 cells (10 x 10)
bbox_width = 9

sim$sample_cells("A1", 
                 bottom_left = 
                   c(400, 400),
                 top_right = 
                   c(400 + bbox_width, 400 + bbox_width)
                 )

sim$sample_cells("B1", 
                 bottom_left = 
                   c(500, 500),
                 top_right = 
                   c(500 + bbox_width, 500 + bbox_width)
                 )
```

Let us visualise the two boxes.

```{r,  fig.height=4, fig.width=3}
library(ggplot2)

# Add the contours of the bounding boxes
current +
  geom_rect(
    xmin = 400, 
    xmax = 400 + bbox_width,
    ymin = 400, 
    ymax = 400 + bbox_width,
    fill = NA, 
    color = "black"
    ) + 
  geom_rect(
    xmin = 500, 
    xmax = 500 + bbox_width,
    ymin = 500, 
    ymax = 500 + bbox_width,
    fill = NA, 
    color = "black"
    ) 
```

> Sampling removes cells from the tissue, as if the tissue was surgically resected.

The method `sample_cells` removes the cells from the simulation and, because of this 
reason, a new call to `plot_tissue` will show the box where the cells have been 
removed to be white.

```{r,  fig.height=4, fig.width=3, message=FALSE, warning=FALSE}
plot_tissue(sim)
```

This is also reflected by `get_cells`, which now will not find any tumour cell in 
the sampled region.
```{r}
# This should be empty
sim$get_cells(c(400, 400), c(400 + bbox_width, 400 + bbox_width)) %>% head
```

### Tissue simulation

Let us move forward the simulation again.

```{r,  fig.height=4, fig.width=3}
# Move to 400K cells
sim$run_up_to_size("A", 400000)

current <- plot_tissue(sim)
current
```

### Second sampling

We sample twice (`"A2"` and `"B2"`) on the same locations as 
before. Those two regions, which were emptied by our previous sampling,
may now contain again some tumour cells as an effect of the last  
simulation evolution.

```{r}
# Bounding boxes as before
sim$sample_cells("A2", 
                 bottom_left = 
                   c(400, 400),
                 top_right = 
                   c(400 + bbox_width, 400 + bbox_width)
                 )

sim$sample_cells("B2", 
                 bottom_left = 
                   c(500, 500),
                 top_right = 
                   c(500 + bbox_width, 500 + bbox_width)
                 )
```

The method `get_samples_info()` provides an overview of the collected samples 
during the simulation up to this point.

```{r}
sim$get_samples_info()
```

### Cell division tree for samples cells

We can now build the forest of cell divisions for all the cells 
that we have sampled (at every time point).

> The internal nodes of the built forest represent cells that were simulated and died before sampling.

```{r}
# The forest is an object of the S4 class `SamplesForest`
forest <- sim$get_samples_forest()
```

We can get the nodes in the forest by using the forest method `get_nodes()`.

```{r}
forest$get_nodes() %>% head
```

The leaves of the forest embody the cells sampled during the
simulation, while the internal nodes represent ancestors of 
the sampled cells.

Hence, the field `sample` is not available for internal nodes, 
while it reports the name of the sample in which the 
corresponding cell was sampled for any leaf. 

```{r}
# get some of the leaves in the forest. They represent sampled cells
forest$get_nodes() %>% filter(!is.na(.data$sample)) %>% head
```

The roots of the forest having no ancestors.

```{r}
forest$get_nodes() %>% filter(is.na(.data$ancestor))
```

We can also query the forest about the samples used to build it.

```{r}
forest$get_samples_info()
```

We can visualise the tree of the cells

```{r,  fig.height=6, fig.width=9}
plot_sampled_cells(sim)
```

```{r echo=FALSE, results='hide', message=FALSE, warning=FALSE}
unlink(sim$get_name(), recursive = TRUE)
```

## Example with two populations

We can now simulate a rather more complex model, with epigenetic switches and subclonal expansions

```{r,  fig.height=4, fig.width=3}
sim <- new(Simulation, "TwoClones")

# First clone
sim$add_genotype(name = "A",
                 epigenetic_rates = c("+-" = 0.01, "-+" = 0.01),
                 growth_rates = c("+" = 0.1, "-" = 0.08),
                 death_rates = c("+" = 0.1, "-" = 0.01))

sim$place_cell("A+", 500, 500)
sim$run_up_to_size("A+", 1000)
plot_tissue(sim, num_of_bins = 500)
```

We sample before introducing a new clone.

```{r,  fig.height=4, fig.width=3}
bbox_width = 10

sim$sample_cells("A1", 
                 bottom_left = c(480, 480), 
                 top_right = c(480 + bbox_width, 480 + bbox_width))

sim$sample_cells("B1", 
                 bottom_left = c(500, 500), 
                 top_right = c(500 + bbox_width, 500 + bbox_width))

plot_tissue(sim, num_of_bins = 500)

# Let it grow a bit more
sim$run_up_to_time(sim$get_clock() + 15)

plot_tissue(sim, num_of_bins = 500)
```

Add a new subclone.
```{r,  fig.height=4, fig.width=3}
cell <- sim$choose_cell_in("A")

sim$add_genotype(name = "B",
                 epigenetic_rates = c("+-" = 0.05, "-+" = 0.1),
                 growth_rates = c("+" = 0.5, "-" = 0.3),
                 death_rates = c("+" = 0.05, "-" = 0.05))

sim$mutate_progeny(cell, "B")

# let it grow more time units
sim$run_up_to_time(sim$get_clock() + 25)

plot_tissue(sim, num_of_bins = 500)
```

Sample again and plot the tissue
```{r,  fig.height=4, fig.width=3}

sim$sample_cells("A2", 
                 bottom_left = c(480, 480), 
                 top_right = c(480 + bbox_width, 480 + bbox_width))

sim$sample_cells("B2", 
                 bottom_left = c(500, 500), 
                 top_right = c(500 + bbox_width, 500 + bbox_width))

plot_tissue(sim, num_of_bins = 500)
```

Now we show the cell division tree, which starts being rather complicated

```{r,  fig.height=12, fig.width=17}
plot_sampled_cells(sim)
```