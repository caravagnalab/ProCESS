---
title: "2.Sampling from a tissue"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{2.Sampling from a tissue}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(rRACES)
library(dplyr)
```

If we now how to [simulate a tissue](../Tissue_simulation.html) then we can add to our models the sampling of tumour cells. We will show this using two types of simulations, one with a single population, and another with two. Moreover, the type of sampling we implement is of the most general kind:

- multi-region, where at every time point multiple spatially-separated samples are collected;
- longitudinal, where the sampling is repeated at multiple time-points.

## Example with one population

```{r echo=FALSE, results='hide', message=FALSE, warning=FALSE}
if (exists("sim")) {
    unlink(sim$get_name(), recursive = TRUE)
}
```

### Tissue simulation

We use a simple monoclonal model.

```{r, eval=TRUE}
# Monoclonal model, no epigenetic rates
sim <- new(Simulation, "Monoclonal")

sim$add_genotype(name = "A", growth_rates = 0.1, death_rates = 0.01)

sim$place_cell("A", 500, 500)
sim$history_delta = 1
sim$run_up_to_size("A", 200000)
```

```{r,  fig.height=4, fig.width=3}
current = plot_tissue(sim)
current
```

### First sampling

A sample is defined by a bounding box, which has these parameters:

- a $(x,y)$ coordinate for the bottom left point;
- a $(x,y)$ coordinate for the top right point.

For this simulation, we define two samples with names `"A1"` and `"B1"`. 

> When using multiple samples from the same tissue, the bounding boxes of the samples have to be non-overlapping.

```{r, eval=FALSE}
# Bounding box from (400, 400) to (480, 480)
sim$sample_cells("A1", bottom_left = c(400, 400), top_right = c(480, 480))

# Bounding box from (550, 550) to (630, 630)
sim$sample_cells("B1", bottom_left = c(550, 550), top_right = c(630, 630))
```

It is possible to visualise the two boxes. 
```{r,  fig.height=4, fig.width=4}
library(ggplot2)

# Add the contours of the bounding boxes
current + 
  geom_rect(xmin = 400, xmax = 480, ymin = 400, ymax = 480, fill = NA, color = 'black') +
  geom_rect(xmin = 550, xmax = 630, ymin = 550, ymax = 630, fill = NA, color = 'black')
```

> Sampling removes cells from the tissue, as if the tissue was surgically resected.

Note that the definition of a sample by function `sample_cells` removes the cells from the simulation and, for this reason, a new call to `plot_tissue` will show the box where the cells have been removed to be white
```{r,  fig.height=4, fig.width=3, message=FALSE, warning=FALSE}
plot_tissue(sim)
```

This is also reflected by `get_cells`, which now will not find any tumour cell in the sampled region
```{r}
# This should be empty
sim$get_cells(c(550, 550), c(630, 630)) %>% head
```

### Tissue simulation

Now we can move forward the simulation prior to sampling again the tissue

```{r,  fig.height=4, fig.width=3}
# Move to 400K cells
sim$run_up_to_size("A", 400000)

current = plot_tissue(sim)
current
```

### Second sampling

Again, we sample twice (`"A2"` and `"B2"`) on the same locations as before (which have been re-filled with cells).

```{r, eval=FALSE}
# Bounding boxes as before
sim$sample_cells("A2", bottom_left = c(400, 400), top_right = c(480, 480))
sim$sample_cells("B2", bottom_left = c(550, 550), top_right = c(630, 630))
```

It is possible to visualise the two boxes. 
```{r,  fig.height=4, fig.width=4}
# Add the contours of the bounding boxes
current + 
  geom_rect(xmin = 400, xmax = 480, ymin = 400, ymax = 480, fill = NA, color = 'black') +
  geom_rect(xmin = 550, xmax = 630, ymin = 550, ymax = 630, fill = NA, color = 'black')
```

### Cell division tree for samples cells

We have the possibility of obtaining the tree of cell divisions for all the cells that we have sampled (at every time point). This information is provided as a dataframe with the information of all the cells.

> Note that tree this contains ancestor cells that were present in the simulation prior to sampling.

```{r,eval=FALSE}
# The tree is a complex object
tree_divisions = sim$get_tree_sampled_cells()
```

```{r echo=FALSE, results='hide', message=FALSE, warning=FALSE}
unlink(sim$get_name(), recursive = TRUE)
```

## Example with two populations
