---
title: "RCpp interface"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{RCpp interface}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(rRACES)

library(dplyr)
```

# Simulating tumour growth

This is an example run with the Rcpp interface.

## Tissue specification

We create a new simulation and set one custom output data directory where RACES will dump outputs (binary files). A 1000x1000-cells tissue is automatically added to the simulation.
```{r echo=FALSE, results='hide', message=FALSE, warning=FALSE}
unlink("output_dir", recursive = TRUE)
```

```{r}
sim <- new(Simulation, "output_dir")
```

Now, `sim` is an S4 class `Simulation`, which exposes a number of getters that we are showing in this example.
```{r}
# Get the simulation directory, i.e., "output_dir"
sim$get_directory()

# Get the tissue size, i.e., c(1000,1000)
sim$get_tissue_size()
```

The *death activation level* is the minimum number of cells in a species that enables cell 
death. The cell of a species $S$ can die if and only if that $S$ has reached the death 
activation level at least once during the simulation. 

This level is global threshold that holds for all the species and it is set to 0 by default.

```{r}
sim$death_activation_level
```

In order to avoid species drift, we can rise this value as much as we want.
```{r}
sim$death_activation_level <- 50
```

We can change the tissue conformation, and name the tissue to anything we want.

```{r}
# Set the tissue name and size to different values
sim$update_tissue("Liver", 1200, 900)

# Get the tissue name, i.e., "Liver"
sim$get_tissue_name()

# Get the tissue size, i.e., c(1200,900)
sim$get_tissue_size()
```

## Species and their evolutionary relations

In order to simulate the evolution of some species we need to add them to our object. This process defines the evolutionary parameters of the species. For example, we define two genotypes `A` and `B`, with their epigenetic states `+`/`-`, called epistates. Overall, we define the 4 species:

- `A+` and `A-`, as a proxy for the genotype `A` with the reversible `+`/`-` marker;
- `B+` and `B-`, as a proxy for the genotype `B` with the reversible `+`/`-` marker;

For each species we define the parameters:

- growth rate $\lambda$: rate at which cells duplicate inheriting the epigenetic marker (e.g., one cell of type `A+` creates two cells of type `A+`);
- death rate: rate at which cells di (e.g., one cell of type `A+` is removed from the simulation);
- epigenetic_rate: : rate `+-` or `-+` at which cells duplicate and flip the epigenetic marker of one of the progeny (e.g., one cell of type `A+` determines one type `A+` and one of type `A-`, or viceversa);

```{r}
# add two genotype, "A" and "B", together with their species
sim$add_genotype(name = "A",
                 epigenetic_rates = c("+-" = 0.01, "-+" = 0.01),
                 growth_rates = c("+" = 0.2, "-" = 0.08),
                 death_rates = c("+" = 0.1, "-" = 0.01))

sim$add_genotype(name = "B",
                 epigenetic_rates = c("+-" = 0.05, "-+" = 0.05),
                 growth_rates = c("+" = 0.1, "-" = 0.3),
                 death_rates = c("+" = 0.05, "-" = 0.1))
```

At this point no evolutionary relation between the genotypes `A` and `B` is defined. We need to add a parent/child relation which will fire at a predefined simulation time, in any of the cells in the `+`/`-` state. 

For example, I can program a timed transition from species one cell of genotype `A` to one of genotype `B`, at time `30`. In this case, a cell at random from species `A+` or `A-` will be selected and will be assigned a new type `B+` or `B-` depending on its epistate.

```{r}
# Schedule a mutation at time 40 from one of the species of
# genotype "A" to the species of "B" having the same
# epigenetic state
sim$schedule_genotype_mutation("A", "B", 40)

# Get the simulation species with epigenetic state names
sim$get_species_names()
```

## Initial cell displacement

To be able to simulate the model, an initial cell needs to be displaced in the tissue. We add one cell of species `A+` (genotype `A` in epistate `+`) in position `(500, 500)`.

```{r}
sim$add_cell("A+", 500, 500)
```

We can query the current state of the simulation, and extract the cell position
```{r}
# Counts per species
sim$get_counts()

# Cells position
sim$get_cells()
```

## Simulation of the evolution of the species

At the beginnig, the simulation clock is `0` and no events have been fired.
```{r}
# Get the number of fired event per species
sim$get_firings()

# Get simulation time
sim$get_clock()
```

There are 3 ways to move the simulation forward:

- advancing until a new time `t` is reached;
- advancing until a species reaches a certain size;
- advancing until a desired number of firings (of one particular event) has happened.

```{r}

# Run the simulation up until the there are less than 500 cells in 
# the species A+
sim$run_up_to_size("A+", 500)

# Counts per species now reports 500 for A+
sim$get_counts()

sim$get_firings()
```

A small number of cell deaths have occurred in species "A-" up to this point.
Let us simulate the system until there are 100 of them at least.

```{r}
sim$run_up_to_event("death", "A-", 100)

# Get the number of fired event per species. The row "death", "A",
# "-" now reports 100.
sim$get_firings()
```

```{r}
# Get the simulation clock
sim$get_clock() 

# Run the simulation for other 15 time units
sim$run_up_to_time(sim$get_clock() + 15)

# Get again the simulation clock
sim$get_clock()
```

At this point, we can query the simulation configuration in a number of ways.

Let us use `dplyr` to filter the query results.
```{r, message=FALSE}
# load dplyr to use %>%
require(dplyr)
```

```{r}
# Get the cells in the tissue at current simulation time
sim$get_cells() %>% head()

# Get the cells in the tissue rectangular sample having
# [500,500] and [505,505] as lower and upper corners, respectively
sim$get_cells(c(500, 500), c(505, 505))  %>% head()

# Get the cells in the tissue having epigenetic state "-"
sim$get_cells(c("A", "B"), c("-")) %>% head()

# Get the cells in the tissue having epigenetic state "-" and,
# at the same time, belonging to rectangular sample bounded by
# [500,500] and [505,505] as lower and upper corners, respectively
sim$get_cells(c(500, 500), c(505, 505), c("A", "B"), c("-"))  %>% head()
```

We can also randomly select one of the cells in a genotype or 
one of the cells that belongs to a genotype and lays in a rectangular 
selection.

```{r}
# randomly select one cell in the genotype "A"
sim$choose_cell_in("A")

# calling it again may result in a different cell
sim$choose_cell_in("A")

# randomly select one cell in the genotype "A"
# in the tissue rectangular selection [500,550]x[350,450]
sim$choose_cell_in("A",  c(500, 350), c(550, 450))
```

If, at this point in the simulation, we would like to generate a new genotype 
`C` from one of the cells having genotype `A` in the rectangle 
$[450,500]\times [550, 600]$, we need to:


1. randomly select one cell among those of `A` laying in $[450,500]\times [550, 600]$ by calling `choose_cell_in`
2. setup the new genotype `C`
3. call the `mutate_progeny` method

```{r}
# Identify one cell among those of `A` laying in the rectangle
# [450,500]x[550,600]
cell <- sim$choose_cell_in("A",  c(450, 550), c(500, 600))

cell

# add the genotype "C" together with its species
sim$add_genotype(name = "C",
                epigenetic_rates = c("+-" = 0.01, "-+" = 0.01),
                growth_rates = c("+" = 0.2, "-" = 0.3),
                death_rates = c("+" = 0.1, "-" = 0.01))

# simulate the duplication of the cell and switch the genotype of one
# of its progeny (the one laying in the original position) into "C"
sim$mutate_progeny(cell, "C")

# the new cell in the original position has genotype "C"
sim$get_cell(cell$position_x, cell$position_y)
```

At the end of the computation, the directory `output_dir` will contain simulated data usable by RACES.